import { BaseService } from '@api/core/services/base.service'
import { CreateWorkflowStateRequest, WorkflowStateResponse } from '@/types/dto/workflowStates.dto'
import { Resource } from '@api/core/types/api'
import { generateRandomString, toCamelCase } from '@/utils/string'
import { PoliciesService } from '@api/core/services/policies.service'
import { UserAction } from '@api/core/types/user'

class WorkflowStatesService extends BaseService {
  async getAllWorkflowStates() {
    // Check if current user is authorized to access this resource
    const policyGate = new PoliciesService(this.user)
    policyGate.authorize(UserAction.Read, Resource.Tasks)

    let workflowStates: WorkflowStateResponse[] = await this.db.$queryRaw`
    SELECT * FROM "WorkflowStates"
    WHERE "workspaceId" = ${this.user.workspaceId}
    ORDER BY 
      CASE 
        WHEN "key" = 'todo' THEN 1
        WHEN "key" = 'inProgress' THEN 2
        WHEN "key" = 'completed' THEN 3
        ELSE 4
      END;
  `

    if (!workflowStates.length) {
      await this.setDefaultWorkflowStates()
      // Query workflowStates again because createMany only returns count and not an array of rows
      // also autogenerated ID field needs to be queried again anyway
      workflowStates = await this.db.$queryRaw`
      SELECT * FROM "WorkflowStates"
      WHERE "workspaceId" = ${this.user.workspaceId}
      ORDER BY 
        CASE 
          WHEN "key" = 'todo' THEN 1
          WHEN "key" = 'inProgress' THEN 2
          WHEN "key" = 'completed' THEN 3
          ELSE 4
        END;
    `
    }

    return workflowStates
  }

  async getOneWorkflowState(id: string) {
    const policyGate = new PoliciesService(this.user)
    policyGate.authorize(UserAction.Read, Resource.Tasks)

    return await this.db.workflowState.findFirst({ where: { id } })
  }

  async createWorkflowStates(data: CreateWorkflowStateRequest) {
    const policyGate = new PoliciesService(this.user)
    policyGate.authorize(UserAction.Create, Resource.Tasks)

    return await this.db.workflowState.create({
      data: {
        ...data,
        key: await this.generateKey(data.name),
        workspaceId: this.user.workspaceId,
      },
    })
  }

  /**
   * Sets default workflow states for a fresh workspace
   */
  private async setDefaultWorkflowStates() {
    return await this.db.workflowState.createMany({
      data: [
        { type: 'unstarted', name: 'Todo', key: 'todo', workspaceId: this.user.workspaceId },
        { type: 'started', name: 'In Progress', key: 'inProgress', workspaceId: this.user.workspaceId },
        { type: 'completed', name: 'Done', key: 'completed', workspaceId: this.user.workspaceId },
      ],
    })
  }

  private async generateKey(name: string) {
    let key = toCamelCase(name)
    // If a key matching existing record exists, append a random
    // string since we have UQ_WorkflowState_workspaceId_key constraint
    const matchingKeyRecord = await this.db.workflowState.findFirst({ where: { key } })
    if (matchingKeyRecord) key += `-${generateRandomString(3)}`

    return key
  }
}

export default WorkflowStatesService
